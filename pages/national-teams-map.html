<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>International football matches - visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3-legend.susielu.com/d3-legend.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <link rel="stylesheet" href="../styles/national-teams-style.css" />
  </head>
  <body>
    <header>
      <h1>
        Visualization of international football matches from 1872 to 2024.
      </h1>
      <nav>
        <ul>
          <li><a href="../index.html">Goalscorers</a></li>
          <li>
            <a href="#">National teams - map</a>
          </li>
          <li><a href="./home-away-visual.html">Home/away visual</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <div id="map-container"></div>
      <button id="zoom-out-button">Zoom out</button>
    </main>

    <script>
      let countryNameMapping = {
        "United States of America": "United States",
        "United Kingdom": "England",
        "Bosnia and Herz.": "Bosnia and Herzegovina",
        Ireland: "Republic of Ireland",
        China: "China PR",
        "Dem. Rep. Congo": "DR Congo",
        "S. Sudan": "Sudan",
        "CÃ´te d'Ivoire": "Ivory Coast",
        "Dominican Rep.": "Dominican Republic",
        Czechia: "Czech Republic",
        Macedonia: "North Macedonia",
        "Central African Rep.": "Central African Republic",
        "Eq. Guinea": "Equatorial Guinea",
        "W. Sahara": "Western Sahara",
      };

      const colors = [
        "#00FF00",
        "#19FF00",
        "#33FF00",
        "#4DFF00",
        "#66FF00",
        "#80FF00",
        "#99FF00",
        "#B3FF00",
        "#CCFF00",
        "#E6FF00",
        "#FFFF00",
        "#FFE600",
        "#FFCC00",
        "#FFB300",
        "#FF9900",
        "#FF8000",
        "#FF6600",
        "#FF4D00",
        "#FF3300",
        "#FF0000",
      ];

      var width = window.innerWidth;
      var height = window.innerHeight;

      var projection = d3
        .geoMercator()
        .scale(150)
        .translate([width / 2.55, height / 2]);

      var path = d3.geoPath().projection(projection);

      var svg = d3
        .select("#map-container")
        .append("svg")
        .attr("id", "map")
        .attr("width", width)
        .attr("height", height);

      var g = svg.append("g");

      var tooltip = d3.select("body").append("div").attr("class", "tooltip");

      var zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed);

      svg.call(zoom).on("mousedown.zoom", null);

      d3.select("#zoom-out-button").on("click", function () {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
      });

      function zoomed(event) {
        g.attr("transform", event.transform);
      }

      let resultsData;
      let results = {};
      let colorScale;

      d3.json("../datasets/results.json")
        .then((data) => {
          resultsData = data;
          console.log(resultsData);

          resultsData.forEach((match) => {
            if (!results[match.home_team]) {
              results[match.home_team] = { wins: 0, losses: 0, draws: 0 };
            }
            if (!results[match.away_team]) {
              results[match.away_team] = { wins: 0, losses: 0, draws: 0 };
            }

            if (match.home_score > match.away_score) {
              // Home team wins, away team loses
              results[match.home_team].wins += 1;
              results[match.away_team].losses += 1;
            } else if (match.home_score < match.away_score) {
              // Away team wins, home team loses
              results[match.away_team].wins += 1;
              results[match.home_team].losses += 1;
            } else {
              // Draw
              results[match.home_team].draws += 1;
              results[match.away_team].draws += 1;
            }
          });

          // Calculate total efficiency for each team
          for (let team in results) {
            let totalMatches =
              results[team].wins + results[team].draws + results[team].losses;
            let totalPointsEarned =
              results[team].wins * 3 + results[team].draws;
            let efficiency = totalPointsEarned / (totalMatches * 3);
            results[team].efficiency = efficiency * 100;
          }

          console.log(results["Brazil"]);
          let minEfficiency = d3.min(
            Object.values(results),
            (d) => d.efficiency
          );
          let maxEfficiency = d3.max(
            Object.values(results),
            (d) => d.efficiency
          );
          console.log(minEfficiency, maxEfficiency);
          colorScale = d3
            .scaleQuantize()
            .domain([minEfficiency, maxEfficiency])
            .range(colors);

          let legend = d3
            .legendColor()
            .labelFormat(d3.format("d"))
            .title("Efficiency")
            .shape("rect")
            .shapeWidth(30)
            .orient("vertical")
            .scale(colorScale);

          d3.select("svg")
            .append("g")
            .attr("transform", "translate(20,30)")
            .style("font-size", "14px")
            .call(legend);

          d3.json(
            "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"
          )
            .then((world) => {
              var states = g
                .selectAll("path")
                .data(topojson.feature(world, world.objects.countries).features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", path)
                .style("stroke", "gray")
                .style("fill", function (d) {
                  var countryName = d.properties.name;
                  var mappedCountryName =
                    countryNameMapping[countryName] || countryName;

                  var countryResults = results[mappedCountryName] || {
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    efficiency: 0,
                  };

                  return colorScale(countryResults.efficiency);
                })
                .style("stroke-width", 0.5)
                .on("mouseover", function (event, d) {
                  console.log(d.properties.name);
                  var countryName = d.properties.name;
                  var mappedCountryName =
                    countryNameMapping[countryName] || countryName;
                  var countryResults = results[mappedCountryName] || {
                    wins: 0,
                    losses: 0,
                    draws: 0,
                  };
                  tooltip.transition().duration(200).style("opacity", 0.9);
                  tooltip
                    .html(
                      "Country: " +
                        countryName +
                        "<br>" +
                        "Wins: " +
                        countryResults.wins +
                        "<br>" +
                        "Losses: " +
                        countryResults.losses +
                        "<br>" +
                        "Draws: " +
                        countryResults.draws +
                        "<br>" +
                        "Efficiency: " +
                        countryResults.efficiency.toFixed(2) +
                        "%"
                    )
                    .style("left", event.pageX + "px")
                    .style("top", event.pageY - 28 + "px");
                })
                .on("mouseout", function () {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
            })
            .catch((error) => console.error(error));
        })
        .catch((error) => console.error(error));
    </script>
  </body>
</html>
